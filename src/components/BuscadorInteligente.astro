---
// src/components/BuscadorInteligente.astro
import softwares from '../softwares.json';

// DEFINIMOS LOS MISMOS FILTROS QUE EN [SECTOR].ASTRO PARA QUE COINCIDAN LOS NÃšMEROS
const filtros = {
  fontaneros: ['fontaneros', 'fontanerÃ­a', 'desatascos', 'pocerÃ­a', 'calefacciÃ³n'],
  electricistas: ['electricistas', 'instalador', 'mantenimiento', 'telecomunicaciones', 'fotovoltaica'],
  reformas: ['reformas', 'construcciÃ³n', 'albaÃ±ilerÃ­a', 'pintores', 'interiorismo'],
  climatizacion: ['climatizaciÃ³n', 'aire acondicionado', 'hvac', 'frigoristas', 'calefacciÃ³n'], // ID corto para uso interno
  talleres: ['talleres', 'taller', 'mecÃ¡nico', 'chapa', 'automociÃ³n'],
  cerrajeros: ['cerrajeros', 'cerrajerÃ­a', 'seguridad', 'puertas'],
  carpinteros: ['carpinteros', 'carpinterÃ­a', 'madera', 'aluminio', 'ebanisterÃ­a'],
  jardineros: ['jardineros', 'jardinerÃ­a', 'paisajismo', 'piscinas'],
  limpieza: ['limpieza', 'limpiezas', 'servicios', 'facility']
};

// FunciÃ³n auxiliar para contar coincidencias exactas
const getStats = (keywords) => {
  const matches = softwares.filter(s => 
    s.target_gremios && s.target_gremios.some(g => {
      const gLower = g.toLowerCase();
      return keywords.some(k => gLower.includes(k));
    })
  );
  
  // Si no hay softwares, ponemos precio ficticio para no romper, si hay, sacamos el mÃ­nimo real.
  const minPrice = matches.length > 0 
    ? Math.min(...matches.map(s => s.pricing?.start_price || 99)) 
    : 0;

  return { count: matches.length, minPrice };
};

// Preparamos los datos
const stats = {
  fontaneros: getStats(filtros.fontaneros),
  electricistas: getStats(filtros.electricistas),
  reformas: getStats(filtros.reformas),
  'climatizacion-y-aire-acondicionado': getStats(filtros.climatizacion), // OJO: Usamos la Key larga de la URL
  talleres: getStats(filtros.talleres),
  cerrajeros: getStats(filtros.cerrajeros),
  carpinteros: getStats(filtros.carpinteros),
  jardineros: getStats(filtros.jardineros),
  limpieza: getStats(filtros.limpieza),
  general: { count: softwares.length, minPrice: 20 }
};
---

<div class="bg-white rounded-2xl shadow-xl border border-blue-100 p-6 md:p-8 max-w-3xl mx-auto -mt-24 relative z-20">
  <div class="text-center mb-6">
    <h2 class="text-2xl font-black text-slate-800 mb-2">ğŸ’° Calculadora de Software</h2>
    <p class="text-slate-500 text-sm">Descubre cuÃ¡nto cuesta digitalizar tu empresa en 2026</p>
  </div>

  <form id="calculatorForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
    
    <div class="space-y-2">
      <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Soy...</label>
      <select id="sectorSelect" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
        <option value="" disabled selected>Elige tu oficio</option>
        <option value="fontaneros">ğŸ”§ Fontanero</option>
        <option value="electricistas">âš¡ Electricista</option>
        <option value="reformas">ğŸ§± Reformista</option>
        <option value="climatizacion-y-aire-acondicionado">â„ï¸ Frigorista / RITE</option>
        <option value="talleres">ğŸš— Taller MecÃ¡nico</option>
        <option value="cerrajeros">ğŸ”‘ Cerrajero</option>
        <option value="carpinteros">ğŸªš Carpintero</option>
        <option value="jardineros">ğŸŒ¿ Jardinero</option>
        <option value="limpieza">âœ¨ Empresa Limpieza</option>
      </select>
    </div>

    <div class="md:col-span-2 bg-blue-50 rounded-xl p-4 flex items-center justify-between border border-blue-100 opacity-50 transition-all" id="resultBox">
      <div>
        <span class="block text-xs font-bold text-blue-400 uppercase mb-1" id="resultTitle">Selecciona un oficio...</span>
        <div class="flex items-baseline gap-2">
          <span class="text-3xl font-black text-blue-900" id="priceDisplay">--â‚¬</span>
          <span class="text-sm text-blue-700 font-medium">/mes</span>
        </div>
      </div>
      <div class="text-right">
        <span class="block text-xs font-bold text-slate-400 uppercase">Opciones</span>
        <span class="text-xl font-bold text-slate-700" id="countDisplay">0</span>
      </div>
    </div>

    <button type="submit" id="submitBtn" class="md:col-span-3 w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-black py-4 rounded-xl text-lg shadow-lg shadow-blue-200 transform hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
      VER COMPARATIVA
    </button>
  </form>
</div>

<script define:vars={{ stats }}>
  // LÃ³gica Cliente (Se ejecuta en el navegador)
  const select = document.getElementById('sectorSelect');
  const resultBox = document.getElementById('resultBox');
  const priceDisplay = document.getElementById('priceDisplay');
  const countDisplay = document.getElementById('countDisplay');
  const resultTitle = document.getElementById('resultTitle');
  const btn = document.getElementById('submitBtn');

  select.addEventListener('change', (e) => {
    const sector = e.target.value;
    // Si existe el sector en stats, lo usamos, si no, usamos general
    let data = stats[sector] || stats.general;

    // Efecto visual de "cÃ¡lculo"
    resultBox.classList.remove('opacity-50');
    resultBox.classList.add('animate-pulse'); // PequeÃ±o parpadeo
    
    setTimeout(() => {
      resultBox.classList.remove('animate-pulse');
      priceDisplay.innerText = `desde ${data.minPrice}â‚¬`;
      countDisplay.innerText = `${data.count} Softwares`;
      resultTitle.innerText = `Precios de mercado 2026:`;
      
      // Activar botÃ³n
      btn.removeAttribute('disabled');
      btn.innerText = `VER ${data.count} OPCIONES PARA ${sector.split('-')[0].toUpperCase()}`; // Truco visual para cortar nombres largos
    }, 200);
  });

  // RedirecciÃ³n al hacer submit
  document.getElementById('calculatorForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const sector = select.value;
    if (sector) {
      window.location.href = `/software/${sector}`;
    }
  });
</script>