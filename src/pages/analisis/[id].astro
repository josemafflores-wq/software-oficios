---
// src/pages/analisis/[id].astro
import softwares from '../../softwares.json';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  return softwares.map((soft) => ({
    params: { id: soft.id },
    props: { software: soft },
  }));
}

const { software } = Astro.props;

// CORRECCI√ìN DE PRECIO: Si es 0, mostramos "GRATIS", si no, el precio.
const precioDisplay = software.pricing?.start_price === 0 
  ? "GRATIS" 
  : (software.pricing?.start_price ? `${software.pricing.start_price}‚Ç¨` : "Consultar");

// Cargamos las FAQs gen√©ricas del JSON (luego inyectaremos la espec√≠fica por JS)
const faqsFinales = [...(software.faqs_seo || [])];

// SCHEMA JSON-LD (SEO T√âCNICO)
const schema = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": software.name,
  "operatingSystem": "Web, Android, iOS",
  "applicationCategory": "BusinessApplication",
  "offers": { "@type": "Offer", "price": software.pricing?.start_price || "0", "priceCurrency": "EUR" },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8", 
    "ratingCount": "24"
  },
  ...(software.video_demo_id ? {
    "subjectOf": {
      "@type": "VideoObject",
      "name": `Demo de ${software.name} 2026`,
      "description": `V√≠deo demostraci√≥n de las funcionalidades principales de ${software.name}.`,
      "thumbnailUrl": `https://img.youtube.com/vi/${software.video_demo_id}/hqdefault.jpg`,
      "uploadDate": "2026-01-01T08:00:00+08:00",
      "contentUrl": `https://www.youtube.com/watch?v=${software.video_demo_id}`,
      "embedUrl": `https://www.youtube.com/embed/${software.video_demo_id}`
    }
  } : {})
};
---

<Layout 
    title={`${software.name}: Precio, Opiniones y An√°lisis 2026`}
    description={`Descubre si ${software.name} es el mejor software para tu negocio. An√°lisis de precios, funci√≥n VeriFactu y opiniones reales de expertos.`}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  {/* HERO SECTION */}
  <div class="bg-indigo-900 text-white py-12 md:py-16 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="max-w-6xl mx-auto px-4 md:flex items-center gap-8 relative z-10">
      <div class="md:w-1/4 flex justify-center md:justify-start mb-6 md:mb-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-48 h-48 flex items-center justify-center transform hover:scale-105 transition-transform duration-300">
            {software.logo_url ? <img src={software.logo_url} alt={`Logo ${software.name}`} class="max-h-full max-w-full object-contain" /> : <span class="text-4xl font-black text-slate-300">{software.name[0]}</span>}
        </div>
      </div>
      <div class="md:w-3/4 text-center md:text-left">
        <div class="flex flex-wrap gap-3 justify-center md:justify-start mb-4">
            {software.legal_spain?.verifactu_ready && <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full uppercase tracking-wide border border-green-400">‚úÖ Verifactu</span>}
            {software.kit_digital_eligible && <span class="px-3 py-1 bg-blue-500 text-white text-xs font-bold rounded-full uppercase border border-blue-400">Kit Digital</span>}
        </div>
        
        {/* T√çTULO H1 DIN√ÅMICO (Se reescribe con JS) */}
        <h1 id="dynamic-h1" class="text-3xl md:text-5xl font-bold mb-4 tracking-tight">{software.name}</h1>
        
        <p class="text-xl text-indigo-100 max-w-2xl mb-8 leading-relaxed">{software.short_description}</p>
        <div class="flex flex-wrap gap-4 justify-center md:justify-start items-center">
            <a href={software.url_afiliado} target="_blank" rel="nofollow noopener" class="bg-yellow-400 text-yellow-900 font-bold py-3 px-8 rounded-lg hover:bg-yellow-300 transition shadow-lg transform hover:-translate-y-1 flex items-center gap-2">
                Ver Oferta Oficial <span class="text-xl">‚Üí</span>
            </a>
            <div class="text-indigo-200 text-sm flex items-center gap-1">Desde <span class="text-white text-2xl font-bold">{precioDisplay}</span> {software.pricing?.start_price > 0 && '/mes'}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-12 grid md:grid-cols-3 gap-8 -mt-8 relative z-20">
    <div class="md:col-span-2 space-y-8">
        
        {/* OPINI√ìN DESTACADA (CAJA LATERAL) */}
        <section id="opinion-dinamica" class="p-8 rounded-2xl border-l-4 shadow-sm transition-all duration-300 bg-gray-50 border-gray-500">
            <div class="flex items-center mb-4">
                <span id="opinion-icon" class="text-3xl mr-3">‚≠ê</span>
                <h3 id="opinion-titulo" class="font-bold uppercase text-sm tracking-wider text-gray-900">An√°lisis del Experto</h3>
            </div>
            <p id="opinion-texto" class="italic text-gray-700 text-lg font-medium leading-relaxed">"{software.short_description}"</p>
        </section>

        <section class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span>üîç</span> An√°lisis a fondo</h2>
            
            <div id="texto-analisis-normal" class="prose prose-lg prose-indigo max-w-none text-gray-600 leading-relaxed">
                {/* LISTA DE GREMIOS DIN√ÅMICA */}
                <p>
                    <strong>{software.name}</strong> es una de las soluciones m√°s s√≥lidas para 
                    <span id="lista-gremios-dinamica"> {software.target_gremios?.join(', ')}</span>.
                </p>
                <p>Destaca por su capacidad de {software.features?.slice(0,3).join(', ')}.</p>
                
                {/* P√°rrafo extra para inyectar contenido del Deep Research */}
                <p id="analisis-extra-sector" class="hidden mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 text-indigo-900 font-medium"></p>

                {software.contenido_seo_extenso && <div class="whitespace-pre-line mt-4">{software.contenido_seo_extenso}</div>}
            </div>

            {/* V√çDEO INTEGRADO */}
            {software.video_demo_id && (
              <div class="mt-8 mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><span>üì∫</span> V√≠deo Demostraci√≥n 2026</h3>
                <div class="aspect-video rounded-xl overflow-hidden shadow-lg bg-black">
                  <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${software.video_demo_id}`} title={`${software.name} demo`} frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
              </div>
            )}

            {/* GALER√çA DE LA APP */}
            {software.screenshots && software.screenshots.length > 0 && (
                <div class="mt-8 mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><span>üì±</span> As√≠ es la App por dentro</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {software.screenshots.map((img, index) => (
                            <div class="rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer group">
                                <img src={img} alt={`Captura pantalla ${software.name} ${index + 1}`} class="w-full h-48 object-cover object-top group-hover:scale-105 transition-transform duration-500" loading="lazy" />
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </section>

        <section class="grid md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl border-t-4 border-green-500 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">‚úÖ Lo mejor</h3>
                <ul class="space-y-3 text-sm text-gray-700">{(software.pros || []).map(i => <li>‚Ä¢ {i}</li>)}</ul>
            </div>
            <div class="bg-white p-6 rounded-2xl border-t-4 border-red-500 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">‚ùå A mejorar</h3>
                <ul class="space-y-3 text-sm text-gray-700">{(software.cons || []).map(i => <li>‚Ä¢ {i}</li>)}</ul>
            </div>
        </section>

        <section class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Preguntas Frecuentes 2026</h2>
            <div id="faq-container" class="space-y-4">
                {/* Aqu√≠ se inyectar√° la FAQ Killer por JS primero */}
                {faqsFinales.map((faq) => (
                    <details class="group border border-gray-200 rounded-xl open:bg-gray-50 transition-all">
                        <summary class="flex cursor-pointer items-center justify-between p-5 font-bold text-gray-800 list-none">
                            {faq.pregunta} <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                        </summary>
                        <div class="px-5 pb-5 text-gray-600 leading-relaxed">{faq.respuesta}</div>
                    </details>
                ))}
            </div>
        </section>
    </div>

    <div class="md:col-span-1 space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-indigo-50 sticky top-24">
            <div class="text-center mb-6">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Plan Inicial</p>
                <div class="flex justify-center items-baseline gap-1">
                    {/* AQU√ç EST√Å LA CORRECCI√ìN: Si es 0, ponemos GRATIS en gris oscuro, si no, el n√∫mero */}
                    {software.pricing?.start_price === 0 
                        ? <span class="text-5xl font-extrabold text-slate-900 uppercase">GRATIS</span>
                        : <>
                            <span class="text-5xl font-extrabold text-gray-900">{software.pricing?.start_price || "?"}</span>
                            <span class="text-2xl font-bold text-gray-500">‚Ç¨</span>
                          </>
                    }
                </div>
                {software.pricing?.start_price > 0 && <p class="text-gray-400 text-sm mt-1">/ {software.pricing?.period || "mes"}</p>}
            </div>
            <a href={software.url_afiliado} target="_blank" class="block w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl text-center shadow-md transition-all active:scale-95">Probar Gratis Ahora</a>
            <div class="mt-8 border-t border-gray-100 pt-6">
                <h4 class="font-bold text-gray-800 text-sm mb-4">Ficha T√©cnica</h4>
                <ul class="space-y-3 text-sm">
                    <li class="flex justify-between text-gray-600"><span>Tipo</span><span class="font-medium text-slate-900">{software.tabla_tecnica?.tipo || "Cloud"}</span></li>
                    <li class="flex justify-between text-gray-600"><span>App M√≥vil</span><span class="font-medium text-slate-900">{software.tabla_tecnica?.app_movil ? "S√≠" : "No"}</span></li>
                    <li class="flex justify-between text-gray-600"><span>Soporte</span><span class="font-medium text-slate-900">{software.tabla_tecnica?.soporte_tecnico || "Email"}</span></li>
                </ul>
            </div>
        </div>
    </div>
  </div>

  <script define:vars={{ software }}>
    // Configuraci√≥n visual por sector (Colores e Iconos)
    const sectorConfig = {
        fontaneros: { titulo: "Opini√≥n para Fontaneros", icon: "üîß", clase: "bg-blue-50 border-blue-500 text-blue-900", nombre: "Fontaneros" },
        electricistas: { titulo: "Opini√≥n para Electricistas", icon: "‚ö°", clase: "bg-yellow-50 border-yellow-500 text-yellow-900", nombre: "Electricistas" },
        reformas: { titulo: "Opini√≥n para Reformas", icon: "üß±", clase: "bg-orange-50 border-orange-500 text-orange-900", nombre: "Reformas" },
        climatizacion: { titulo: "Opini√≥n para Climatizaci√≥n", icon: "‚ùÑÔ∏è", clase: "bg-sky-50 border-sky-500 text-sky-900", nombre: "Climatizaci√≥n" },
        cerrajeros: { titulo: "Opini√≥n para Cerrajeros", icon: "üîë", clase: "bg-zinc-100 border-zinc-600 text-zinc-900", nombre: "Cerrajeros" },
        carpinteros: { titulo: "Opini√≥n para Carpinteros", icon: "ü™ö", clase: "bg-amber-50 border-amber-600 text-amber-900", nombre: "Carpinteros" },
        jardineros: { titulo: "Opini√≥n para Jardineros", icon: "üåø", clase: "bg-green-50 border-green-600 text-green-900", nombre: "Jardineros" },
        limpieza: { titulo: "Opini√≥n para Limpieza", icon: "‚ú®", clase: "bg-cyan-50 border-cyan-500 text-cyan-900", nombre: "Limpieza" },
        talleres: { titulo: "Opini√≥n para Taller", icon: "üöó", clase: "bg-red-50 border-red-500 text-red-900", nombre: "Talleres" }
    };

    // FAQs "Killer" espec√≠ficas por sector
    const extraFaqs = {
        fontaneros: { p: "üíß ¬øFunciona realmente en s√≥tanos sin cobertura?", r: "S√≠, es vital. Cuenta con tecnolog√≠a 'Offline First': creas el parte sin red y se sincroniza al salir." },
        electricistas: { p: "‚ö° ¬øGestiona precios de materiales (cobre)?", r: "S√≠. Permite importar tarifas de proveedores masivamente para actualizar precios y no perder margen." },
        reformas: { p: "üß± ¬øGestiona Certificaciones a Origen?", r: "Correcto. Puedes facturar por porcentaje de ejecuci√≥n, descontando autom√°ticamente lo facturado anteriormente." },
        climatizacion: { p: "‚ùÑÔ∏è ¬øSirve para Gases Fluorados?", r: "S√≠, genera los documentos oficiales de trazabilidad de gases y residuos para el Modelo 587." },
        cerrajeros: { p: "üîë ¬øTiene geolocalizaci√≥n para urgencias?", r: "S√≠, puedes ver en el mapa d√≥nde est√° cada t√©cnico para asignar la urgencia al m√°s cercano." },
        carpinteros: { p: "ü™ö ¬øIncluye bocetos en el presupuesto?", r: "S√≠, puedes adjuntar fotos y croquis directamente desde la tablet para cerrar la venta in-situ." },
        limpieza: { p: "‚ú® ¬øC√≥mo fichan los empleados?", r: "Mediante App m√≥vil con GPS o escaneando un c√≥digo QR instalado en el centro del cliente." },
        jardineros: { p: "üåø ¬øPuedo facturar mantenimientos masivos?", r: "S√≠. El d√≠a 1 de mes, genera y env√≠a autom√°ticamente todas las facturas de tus comunidades." },
        talleres: { p: "üöó ¬øImprime el Resguardo de Dep√≥sito?", r: "S√≠, genera el documento legal obligatorio al recepcionar el veh√≠culo con estado y kil√≥metros." }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        let sector = urlParams.get('sector');
        if (sector === 'climatizacion-y-aire-acondicionado') sector = 'climatizacion';

        if (sector && sectorConfig[sector]) {
            const config = sectorConfig[sector];
            
            // 1. DATA MINING: Buscar la opini√≥n en el JSON
            const pluralMap = { 'fontaneros': 'fontanero', 'electricistas': 'electricista', 'reformas': 'reformas', 'climatizacion': 'clima', 'cerrajeros': 'cerrajero', 'carpinteros': 'carpintero', 'jardineros': 'jardinero', 'limpieza': 'limpieza', 'talleres': 'taller' };
            const jsonKey = `opinion_experto_${pluralMap[sector] || sector}`;
            const textoOpinion = software[jsonKey];

            // 2. MODIFICAR UI
            if (textoOpinion) {
                // A. Caja de Opini√≥n Lateral
                document.getElementById('opinion-titulo').textContent = config.titulo;
                document.getElementById('opinion-texto').textContent = `"${textoOpinion}"`;
                document.getElementById('opinion-icon').textContent = config.icon;
                document.getElementById('opinion-dinamica').className = `p-8 rounded-2xl border-l-4 shadow-sm transition-all duration-300 ${config.clase}`;

                // B. P√°rrafo Extra en el Cuerpo
                const extraBox = document.getElementById('analisis-extra-sector');
                if (extraBox) {
                    extraBox.textContent = `üí° Veredicto para ${config.nombre}: ${textoOpinion}`;
                    extraBox.classList.remove('hidden');
                }
            }

            // 3. LIMPIAR LA LISTA DE GREMIOS
            const listaGremios = document.getElementById('lista-gremios-dinamica');
            if (listaGremios) {
                listaGremios.innerHTML = ` <span class="text-indigo-700 font-black text-xl underline decoration-wavy decoration-indigo-300">${config.nombre}</span>`;
            }

            // 4. CAMBIAR H1
            const h1 = document.getElementById('dynamic-h1');
            if (h1) {
                h1.innerHTML = `${software.name} <span class="text-indigo-300 block text-2xl mt-2 md:inline md:text-3xl md:mt-0">para ${config.nombre}</span>`;
            }

            // 5. INYECTAR FAQ KILLER (NUEVO)
            const faqContainer = document.getElementById('faq-container');
            if (faqContainer && extraFaqs[sector]) {
                const nuevaFaq = document.createElement('details');
                nuevaFaq.className = "group border border-blue-200 bg-blue-50 rounded-xl open:bg-blue-100 transition-all mb-4";
                nuevaFaq.open = true; // Que aparezca abierta para llamar la atenci√≥n
                nuevaFaq.innerHTML = `
                    <summary class="flex cursor-pointer items-center justify-between p-5 font-bold text-blue-900 list-none">
                        ${extraFaqs[sector].p} <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="px-5 pb-5 text-blue-800 leading-relaxed font-medium">${extraFaqs[sector].r}</div>
                `;
                faqContainer.prepend(nuevaFaq);
            }
        } 
    });
  </script>
</Layout>