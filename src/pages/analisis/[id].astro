---
// src/pages/analisis/[id].astro
import softwares from '../../softwares.json';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  return softwares.map((soft) => ({
    params: { id: soft.id },
    props: { software: soft },
  }));
}

const { software } = Astro.props;

const precioDisplay = software.pricing?.start_price 
  ? `${software.pricing.start_price}‚Ç¨` 
  : "Consultar";

// --- CEREBRO DE OPINIONES ACTUALIZADO ---
const opinionesData = {
    defecto: {
        titulo: "An√°lisis del Experto",
        texto: software.short_description,
        icon: "‚≠ê",
        clase: "bg-gray-50 border-gray-500 text-gray-900"
    },
    fontaneros: {
        titulo: "La Opini√≥n del Fontanero",
        texto: software.opinion_experto_fontanero || `Pr√°ctico para partes de trabajo, gesti√≥n de materiales y cobro in-situ.`,
        icon: "üîß",
        clase: "bg-blue-50 border-blue-500 text-blue-900"
    },
    reformas: {
        titulo: "Para Empresas de Reformas",
        texto: software.opinion_experto_reformas || `Control de desviaciones presupuestarias, certificaciones y gesti√≥n de industriales.`,
        icon: "üß±",
        clase: "bg-orange-50 border-orange-500 text-orange-900"
    },
    electricistas: {
        titulo: "An√°lisis para Electricistas",
        texto: software.opinion_experto_fontanero || `Gesti√≥n de boletines, mantenimientos preventivos y avisos de aver√≠a urgentes.`,
        icon: "‚ö°",
        clase: "bg-yellow-50 border-yellow-500 text-yellow-900"
    },
    talleres: {
        titulo: "An√°lisis para Taller Mec√°nico",
        texto: software.opinion_experto_taller || `Gesti√≥n de matr√≠culas, ORs, dep√≥sito de veh√≠culos y stock de recambios.`,
        icon: "üöó",
        clase: "bg-red-50 border-red-500 text-red-900"
    },
    cerrajeros: {
        titulo: "Especial Cerrajeros 24h",
        texto: `Indispensable para servicios de urgencia. Permite firma digital de conformidad y cobro con tarjeta en la puerta del cliente.`,
        icon: "üîë",
        clase: "bg-zinc-100 border-zinc-600 text-zinc-900"
    },
    carpinteros: {
        titulo: "Para Carpinter√≠a y Aluminio",
        texto: `Ideal para gestionar presupuestos con medidas, despiece de materiales y control de fabricaci√≥n en taller.`,
        icon: "ü™ö",
        clase: "bg-amber-50 border-amber-600 text-amber-900"
    },
    limpieza: {
        titulo: "Empresas de Limpieza",
        texto: `Control horario de cuadrillas por GPS, planificaci√≥n de rutas recurrentes y gesti√≥n de cuadrantes de trabajo.`,
        icon: "‚ú®",
        clase: "bg-cyan-50 border-cyan-500 text-cyan-900"
    },
    jardineros: {
        titulo: "Jardiner√≠a y Paisajismo",
        texto: `Gesti√≥n de mantenimientos peri√≥dicos estacionales y seguimiento de tratamientos fitosanitarios por cliente.`,
        icon: "üåø",
        clase: "bg-green-50 border-green-600 text-green-900"
    },
    climatizacion: {
        titulo: "Especial Climatizaci√≥n y HVAC",
        texto: `Excelente para el cumplimiento del RITE, gesti√≥n de partes de asistencia t√©cnica y control legal de gases fluorados.`,
        icon: "‚ùÑÔ∏è",
        clase: "bg-sky-50 border-sky-500 text-sky-900"
    }
};

const faqsFinales = [...(software.faqs_seo || [])];

// üî• FIX V√çDEO SCHEMA: A√±adimos datos estructurados del v√≠deo si existe
const schema = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": software.name,
  "offers": { "@type": "Offer", "price": software.pricing?.start_price || "0", "priceCurrency": "EUR" },
  ...(software.video_demo_id ? {
    "subjectOf": {
      "@type": "VideoObject",
      "name": `Demo de ${software.name}`,
      "description": `V√≠deo demostraci√≥n de las funcionalidades principales de ${software.name}.`,
      "thumbnailUrl": `https://img.youtube.com/vi/${software.video_demo_id}/hqdefault.jpg`,
      "uploadDate": "2024-01-01T08:00:00+08:00", // Fecha gen√©rica requerida por Google
      "contentUrl": `https://www.youtube.com/watch?v=${software.video_demo_id}`,
      "embedUrl": `https://www.youtube.com/embed/${software.video_demo_id}`
    }
  } : {})
};
---

<Layout title={`${software.name}: Precio y Opiniones 2025`}>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  {/* HERO SECTION */}
  <div class="bg-indigo-900 text-white py-12 md:py-16 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="max-w-6xl mx-auto px-4 md:flex items-center gap-8 relative z-10">
      <div class="md:w-1/4 flex justify-center md:justify-start mb-6 md:mb-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-48 h-48 flex items-center justify-center transform hover:scale-105 transition-transform duration-300">
            {software.logo_url ? <img src={software.logo_url} alt={`Logo ${software.name}`} class="max-h-full max-w-full object-contain" /> : <span class="text-4xl font-black text-slate-300">{software.name[0]}</span>}
        </div>
      </div>
      <div class="md:w-3/4 text-center md:text-left">
        <div class="flex flex-wrap gap-3 justify-center md:justify-start mb-4">
            {software.legal_spain?.verifactu_ready && <span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full uppercase tracking-wide border border-green-400">‚úÖ Verifactu</span>}
            {software.kit_digital_eligible && <span class="px-3 py-1 bg-blue-500 text-white text-xs font-bold rounded-full uppercase border border-blue-400">Kit Digital</span>}
        </div>
        <h1 class="text-3xl md:text-5xl font-bold mb-4 tracking-tight">{software.name}</h1>
        <p class="text-xl text-indigo-100 max-w-2xl mb-8 leading-relaxed">{software.short_description}</p>
        <div class="flex flex-wrap gap-4 justify-center md:justify-start items-center">
            <a href={software.url_afiliado} target="_blank" rel="nofollow noopener" class="bg-yellow-400 text-yellow-900 font-bold py-3 px-8 rounded-lg hover:bg-yellow-300 transition shadow-lg transform hover:-translate-y-1 flex items-center gap-2">
                Ver Oferta Oficial <span class="text-xl">‚Üí</span>
            </a>
            <div class="text-indigo-200 text-sm flex items-center gap-1">Desde <span class="text-white text-2xl font-bold">{precioDisplay}</span> /mes</div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-12 grid md:grid-cols-3 gap-8 -mt-8 relative z-20">
    <div class="md:col-span-2 space-y-8">
        
        <section id="opinion-dinamica" class="p-8 rounded-2xl border-l-4 shadow-sm transition-all duration-300 bg-gray-50 border-gray-500">
            <div class="flex items-center mb-4">
                <span id="opinion-icon" class="text-3xl mr-3">‚≠ê</span>
                <h3 id="opinion-titulo" class="font-bold uppercase text-sm tracking-wider text-gray-900">An√°lisis del Experto</h3>
            </div>
            <p id="opinion-texto" class="italic text-gray-700 text-lg font-medium leading-relaxed">"{software.short_description}"</p>
        </section>

        <section class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span>üîç</span> An√°lisis a fondo</h2>
            <div id="texto-analisis-normal" class="prose prose-lg prose-indigo max-w-none text-gray-600 leading-relaxed">
                <p><strong>{software.name}</strong> es una de las soluciones m√°s s√≥lidas para {software.target_gremios?.join(' y ')}. Destaca por su capacidad de {software.features?.slice(0,3).join(', ')}.</p>
                {software.contenido_seo_extenso && <div class="whitespace-pre-line mt-4">{software.contenido_seo_extenso}</div>}
            </div>

            {/* CAJAS EXTRA POR SECTOR */}
            <div id="extra-talleres" class="hidden mt-6 p-5 bg-red-50 rounded-xl border border-red-100">
                <h3 class="font-bold text-red-900 flex items-center gap-2 mb-2"><span>üöó</span> Funcionalidades para Taller</h3>
                <p class="text-red-800 text-sm">Entrada por matr√≠cula, gesti√≥n de ORs y control de margen de recambios.</p>
            </div>
            <div id="extra-electricistas" class="hidden mt-6 p-5 bg-yellow-50 rounded-xl border border-yellow-200">
                <h3 class="font-bold text-yellow-900 flex items-center gap-2 mb-2"><span>‚ö°</span> Especial Electricistas</h3>
                <p class="text-yellow-900 text-sm">Gesti√≥n de mantenimientos preventivos y base de precios para boletines.</p>
            </div>
            <div id="extra-fontaneros" class="hidden mt-6 p-5 bg-blue-50 rounded-xl border border-blue-100">
                <h3 class="font-bold text-blue-900 flex items-center gap-2 mb-2"><span>üîß</span> Utilidad para Fontaneros</h3>
                <p class="text-blue-800 text-sm">Firma digital in-situ y modo offline para s√≥tanos sin cobertura.</p>
            </div>
            <div id="extra-reformas" class="hidden mt-6 p-5 bg-orange-50 rounded-xl border border-orange-100">
                <h3 class="font-bold text-orange-900 flex items-center gap-2 mb-2"><span>üß±</span> Gesti√≥n de Reformas</h3>
                <p class="text-orange-900 text-sm">Presupuestos por cap√≠tulos y control de certificaciones a origen.</p>
            </div>
            <div id="extra-cerrajeros" class="hidden mt-6 p-5 bg-zinc-50 rounded-xl border border-zinc-200">
                <h3 class="font-bold text-zinc-900 flex items-center gap-2 mb-2"><span>üîë</span> Gesti√≥n para Cerrajeros</h3>
                <p class="text-zinc-800 text-sm">Asignaci√≥n de avisos urgentes y geolocalizaci√≥n de t√©cnicos en tiempo real.</p>
            </div>
            <div id="extra-carpinteros" class="hidden mt-6 p-5 bg-amber-50 rounded-xl border border-amber-100">
                <h3 class="font-bold text-amber-900 flex items-center gap-2 mb-2"><span>ü™ö</span> Carpinter√≠a y Aluminio</h3>
                <p class="text-amber-900 text-sm">Presupuestos por medidas y control de fabricaci√≥n de ventanas o muebles.</p>
            </div>
            <div id="extra-limpieza" class="hidden mt-6 p-5 bg-cyan-50 rounded-xl border border-cyan-100">
                <h3 class="font-bold text-cyan-900 flex items-center gap-2 mb-2"><span>‚ú®</span> Servicios de Limpieza</h3>
                <p class="text-cyan-900 text-sm">Control horario por GPS en el centro del cliente y facturaci√≥n recurrente.</p>
            </div>
            <div id="extra-jardineros" class="hidden mt-6 p-5 bg-green-50 rounded-xl border border-green-100">
                <h3 class="font-bold text-green-900 flex items-center gap-2 mb-2"><span>üåø</span> Jardiner√≠a Profesional</h3>
                <p class="text-green-900 text-sm">Programaci√≥n de tareas estacionales y control de productos fitosanitarios.</p>
            </div>
            <div id="extra-climatizacion" class="hidden mt-6 p-5 bg-sky-50 rounded-xl border border-sky-100">
                <h3 class="font-bold text-sky-900 flex items-center gap-2 mb-2"><span>‚ùÑÔ∏è</span> Especial Climatizaci√≥n y RITE</h3>
                <p class="text-sky-900 text-sm">Control de gases fluorados, mantenimiento preventivo RITE y partes de SAT.</p>
            </div>

            {/* V√çDEO INTEGRADO */}
            {software.video_demo_id && (
              <div class="mt-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                   <span>üì∫</span> V√≠deo Demostraci√≥n
                </h3>
                <div class="aspect-video rounded-xl overflow-hidden shadow-lg bg-black">
                  <iframe 
                    width="100%" 
                    height="100%" 
                    src={`https://www.youtube.com/embed/${software.video_demo_id}`} 
                    title={`${software.name} demo`}
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen
                  ></iframe>
                </div>
              </div>
            )}
        </section>

        <section class="grid md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl border-t-4 border-green-500 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">‚úÖ Lo mejor</h3>
                <ul class="space-y-3 text-sm text-gray-700">{(software.pros || []).map(i => <li>‚Ä¢ {i}</li>)}</ul>
            </div>
            <div class="bg-white p-6 rounded-2xl border-t-4 border-red-500 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">‚ùå A mejorar</h3>
                <ul class="space-y-3 text-sm text-gray-700">{(software.cons || []).map(i => <li>‚Ä¢ {i}</li>)}</ul>
            </div>
        </section>

        <section class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Preguntas Frecuentes</h2>
            <div class="space-y-4">
                {faqsFinales.map((faq) => (
                    <details class="group border border-gray-200 rounded-xl open:bg-gray-50 transition-all">
                        <summary class="flex cursor-pointer items-center justify-between p-5 font-bold text-gray-800 list-none">
                            {faq.pregunta} <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                        </summary>
                        <div class="px-5 pb-5 text-gray-600 leading-relaxed">{faq.respuesta}</div>
                    </details>
                ))}
            </div>
        </section>
    </div>

    <div class="md:col-span-1 space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-indigo-50 sticky top-24">
            <div class="text-center mb-6">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Plan Inicial</p>
                <div class="flex justify-center items-baseline gap-1">
                    <span class="text-5xl font-extrabold text-gray-900">{software.pricing?.start_price || "?"}</span>
                    <span class="text-2xl font-bold text-gray-500">‚Ç¨</span>
                </div>
                <p class="text-gray-400 text-sm mt-1">/ {software.pricing?.period || "mes"}</p>
            </div>
            <a href={software.url_afiliado} target="_blank" class="block w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl text-center shadow-md transition-all active:scale-95">Probar Gratis Ahora</a>
            <div class="mt-8 border-t border-gray-100 pt-6">
                <h4 class="font-bold text-gray-800 text-sm mb-4">Ficha T√©cnica</h4>
                <ul class="space-y-3 text-sm">
                    <li class="flex justify-between text-gray-600"><span>App</span><span class="font-medium text-slate-900">{software.tabla_tecnica?.app_movil ? "S√≠" : "Web"}</span></li>
                    <li class="flex justify-between text-gray-600"><span>Nube</span><span class="font-medium text-slate-900">{software.tabla_tecnica?.nube ? "S√≠" : "No"}</span></li>
                </ul>
            </div>
        </div>
    </div>
  </div>

  <script define:vars={{ opinionesData }}>
    document.addEventListener('DOMContentLoaded', () => {
        const sector = new URLSearchParams(window.location.search).get('sector'); 
        const box = document.getElementById('opinion-dinamica');
        const titulo = document.getElementById('opinion-titulo');
        const texto = document.getElementById('opinion-texto');
        const icon = document.getElementById('opinion-icon');

        if (sector && opinionesData[sector]) {
            const d = opinionesData[sector];
            titulo.textContent = d.titulo;
            texto.textContent = `"${d.texto}"`;
            icon.textContent = d.icon;
            box.className = `p-8 rounded-2xl border-l-4 shadow-sm transition-all duration-300 ${d.clase}`;
            
            const cajaExtra = document.getElementById(`extra-${sector}`);
            if (cajaExtra) cajaExtra.classList.remove('hidden');
        } 
    });
  </script>
</Layout>